<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ”¿å…šãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>

<!-- PyScript (Latest Stable) -->
<link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
<script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<py-config>
    packages = ["matplotlib", "pandas", "numpy"]
</py-config>

<style>
    body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; }
    .header-area { background: #2c3e50; color: white; padding: 15px 0; margin-bottom: 20px; }
    .simulator-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .result-box { background: #e9ecef; color: #2c3e50; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 5px solid #3498db; }
    .param-label { font-weight: bold; color: #555; font-size: 0.9rem; }
    #plot-area { width: 100%; min-height: 350px; text-align: center; }
    .btn-about { border: 1px solid white; color: white; font-size: 0.8rem; }
</style>
</head>
<body>

<!-- Header -->
<div class="header-area">
    <div class="container d-flex justify-content-between align-items-center">
        <h5 class="m-0">ğŸ—³ï¸ æ”¿å…šãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h5>
        <button class="btn btn-sm btn-about" data-bs-toggle="modal" data-bs-target="#aboutModal">
            â“˜ è§£èª¬
        </button>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Input Panel -->
        <div class="col-lg-4 mb-3">
            <div class="simulator-card">
                <h6 class="mb-3 border-bottom pb-2">ğŸ›ï¸ 1. æ”¿ç­–ã‚’è¨­å®šã™ã‚‹</h6>
                
                <div class="mb-3">
                    <label class="param-label">æ¶ˆè²»ç¨ç‡</label>
                    <input type="range" class="form-range" id="tax_rate" min="0" max="25" value="10" oninput="update_val('val_tax', this.value)">
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">0%</span>
                        <span id="val_tax" class="fw-bold text-primary">10%</span>
                        <span class="text-muted">25%</span>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="param-label">å…¬å…±äº‹æ¥­è²» (å¹´é¡)</label>
                    <input type="range" class="form-range" id="public_inv" min="2" max="20" value="6" oninput="update_val('val_inv', this.value)">
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">2å…†</span>
                        <span id="val_inv" class="fw-bold text-primary">6å…†å††</span>
                        <span class="text-muted">20å…†</span>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="param-label">ç¤¾ä¼šä¿é™ºæ–™è² æ‹… (åŠ´ä½¿è¨ˆ)</label>
                    <input type="range" class="form-range" id="social_sec" min="20" max="40" value="30" oninput="update_val('val_sec', this.value)">
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">20%</span>
                        <span id="val_sec" class="fw-bold text-primary">30%</span>
                        <span class="text-muted">40%</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="param-label">é‡‘åˆ©æ”¿ç­–</label>
                    <input type="range" class="form-range" id="interest" min="-0.1" max="5.0" step="0.1" value="0.25" oninput="update_val('val_int', this.value)">
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">ç·©å’Œ</span>
                        <span id="val_int" class="fw-bold text-primary">0.25%</span>
                        <span class="text-muted">å¼•ç· </span>
                    </div>
                </div>

                <button id="run_btn" class="btn btn-secondary w-100 fw-bold shadow-sm" disabled>
                    ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...
                </button>
            </div>
        </div>

        <!-- Result Panel -->
        <div class="col-lg-8">
            <div class="simulator-card">
                <h6 class="mb-3 border-bottom pb-2">ğŸ“Š 2. 5å¹´å¾Œã®æ—¥æœ¬çµŒæ¸ˆäºˆæ¸¬</h6>
                <div id="plot-area">
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted bg-light rounded" style="min-height:300px;">
                        <small>ã“ã“ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                    </div>
                </div>
                
                <div id="result-text" class="result-box">
                    <strong>ğŸ‘ˆ ä¸Šè¨˜ã®ãƒ‘ãƒãƒ«ã§æ”¿ç­–ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</strong><br>
                    ã‚ãªãŸã®é¸æŠãŒã€éå»ã®ã©ã®æ”¿æ¨©ã«è¿‘ã„ã‹ã€ãã—ã¦5å¹´å¾Œã®ç§ãŸã¡ã®ç”Ÿæ´»ï¼ˆæ‰‹å–ã‚Šãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬ç‡ï¼‰ãŒã©ã†ãªã‚‹ã‹ã‚’å³åº§ã«è¨ˆç®—ã—ã¾ã™ã€‚
                </div>

                <div class="mt-4 text-center">
                    <a id="twitter-share" href="#" target="_blank" class="btn btn-dark disabled rounded-pill px-4 w-100">
                        çµæœã‚’ãƒã‚¹ãƒˆã™ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã¤ã„ã¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€å˜ãªã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒãƒãƒ³ã‚°ã§ã¯ãªãã€çµŒæ¸ˆç‰©ç†å­¦ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦æ”¿ç­–ã®å½±éŸ¿ã‚’å®šé‡çš„ã«è¨ˆç®—ã™ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚</p>
                <hr>
                <h6>ğŸ§ª åŸºç¤ç†è«–</h6>
                <p><strong>Standard Block Comparison Method (SBCM)</strong></p>
                <p class="small text-muted">
                    å¾“æ¥ã®çµŒæ¸ˆå­¦ã§ã¯ãªãã€ç†±åŠ›å­¦ã‚„æµä½“åŠ›å­¦ã®æ³•å‰‡ã‚’çµ±æ²»æ©Ÿæ§‹ã«å¿œç”¨ã—ãŸã€Œçµ±æ²»å·¥å­¦ï¼ˆGovernance Engineeringï¼‰ã€ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
                </p>
                <a href="https://github.com/SBCM-Alliance" target="_blank" class="btn btn-outline-dark btn-sm w-100">
                    GitHub: SBCM-Alliance
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    function update_val(id, val) {
        let suffix = '%';
        if(id === 'val_inv') suffix = 'å…†å††';
        document.getElementById(id).innerText = val + suffix;
    }
</script>

<!-- Python Code -->
<py-script>
import matplotlib.pyplot as plt
import numpy as np
from js import document, window
from pyodide.ffi import create_proxy

def run_simulation(event):
    # 1. å…¥åŠ›å–å¾—
    try:
        tax_rate = float(document.getElementById("tax_rate").value)
        public_inv = float(document.getElementById("public_inv").value)
        social_sec = float(document.getElementById("social_sec").value)
        interest = float(document.getElementById("interest").value)
    except:
        return

    # 2. ç‰©ç†è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ (SBCM Logic)
    base_income = 450 
    
    # ç—›ã¿ã®ä¿å­˜å‰‡
    income_delta = - (tax_rate - 10) * 0.8 - (social_sec - 30) * 0.9
    
    # æ¼å‡ºã®å®šç†
    threshold = 6.0
    if public_inv <= threshold:
        inv_efficiency = 1.0
        distortion_score = 1.0
    else:
        inv_efficiency = 1.0 / ((public_inv - threshold) * 0.5 + 1)
        distortion_score = 1.0 + (public_inv - threshold) * 0.3

    gdp_boost = (public_inv - 6) * inv_efficiency * 0.5
    
    # ã‚¤ãƒ³ãƒ”ãƒ¼ãƒ€ãƒ³ã‚¹ä¸æ•´åˆ
    inf_suppression = interest * 0.6
    mortgage_impact = interest * 1.5 
    
    # çµæœç®—å‡º
    final_income = base_income * (1 + income_delta / 100) - (mortgage_impact * 5)
    final_inflation = 2.0 + gdp_boost * 0.3 - inf_suppression
    
    # æ­´å²çš„ãƒãƒƒãƒãƒ³ã‚°
    history = {
        "æ©‹æœ¬è¡Œé© (1997)": [5, 8, 20, 0.5],
        "å°æ³‰æ”¹é© (2005)": [5, 5, 22, 0.1],
        "æ°‘ä¸»å…šæ”¿æ¨© (2009)": [5, 4, 24, 0.1],
        "ã‚¢ãƒ™ãƒãƒŸã‚¯ã‚¹ (2013)": [8, 10, 26, 0.0],
        "å²¸ç”°æ”¿æ¨© (2024)": [10, 6, 30, 0.25]
    }
    
    current = np.array([tax_rate, public_inv, social_sec, interest])
    best_match = "æœªçŸ¥ã®é ˜åŸŸ"
    min_dist = 9999
    
    for name, params in history.items():
        dist = np.linalg.norm(current - np.array(params))
        if dist < min_dist:
            min_dist = dist
            best_match = name
            
    # ç‰¹æ®Šåˆ¤å®š
    special_tag = ""
    if tax_rate <= 5 and social_sec <= 28:
        best_match = "å›½æ°‘æ°‘ä¸»å…šæ¡ˆ (é«˜åœ§çµŒæ¸ˆ)"
        special_tag = "ã€åˆ¤å®šï¼šæ‰‹å–ã‚Šæœ€å¤§åŒ–ã€‘"
    if tax_rate >= 15 and public_inv >= 10:
        best_match = "è²¡æ”¿ç ´ç¶»ã‚·ãƒŠãƒªã‚ª"
        special_tag = "ã€åˆ¤å®šï¼šç†±çš„æ­» (Heat Death)ã€‘"

    # 3. ã‚°ãƒ©ãƒ•æç”»
    plt.clf()
    fig, ax = plt.subplots(figsize=(6, 4))
    plt.subplots_adjust(bottom=0.15)
    
    labels = ['Income', 'Inflation', 'Inefficiency']
    val_income = 100 + (final_income - base_income)/base_income * 100
    val_inf = 100 + (final_inflation - 2) * 10
    val_dist = 100 + (distortion_score - 1) * 50
    
    values = [val_income, val_inf, val_dist]
    colors = ['#2ecc71', '#e74c3c', '#95a5a6']
    
    ax.bar(labels, values, color=colors, alpha=0.8)
    ax.axhline(100, color='black', linestyle='--', linewidth=1)
    ax.set_ylim(50, 160)
    ax.set_title(f"Simulation Result", fontsize=12)
    ax.set_yticks([])
    
    # å€¤ã®è¡¨ç¤º
    ax.text(0, val_income + 2, f"{int(final_income)}0k", ha='center', fontweight='bold', fontsize=10)
    ax.text(1, val_inf + 2, f"{round(final_inflation, 1)}%", ha='center', fontweight='bold', fontsize=10)
    ax.text(2, val_dist + 2, f"x{round(distortion_score, 1)}", ha='center', fontweight='bold', fontsize=10)
    
    display(fig, target="plot-area", append=False)
    
    # 4. çµæœãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    diff = int(final_income - base_income)
    diff_sign = "+" if diff > 0 else ""
    
    res_html = f"<h6>è¨ºæ–­ï¼šã‚ãªãŸã®æ”¿ç­–ã¯ã€{best_match}ã€ã§ã™</h6>"
    res_html += f"<p class='mb-2 text-danger fw-bold small'>{special_tag}</p>"
    res_html += f"<ul class='small mb-2'>"
    res_html += f"<li>æ‰‹å–ã‚Š: ç´„{int(final_income)}ä¸‡å†† <span class='text-primary'>({diff_sign}{diff}ä¸‡å††)</span></li>"
    res_html += f"<li>ã‚¤ãƒ³ãƒ•ãƒ¬: {round(final_inflation, 1)}%</li>"
    res_html += f"<li>è¡Œæ”¿æ­ªã¿: {round(distortion_score, 1)}å€</li>"
    res_html += f"</ul>"
    
    comment = "<div class='small mt-2'><strong>ğŸ¤– åˆ†æ:</strong><br>"
    if distortion_score > 1.3:
        comment += "å…¬å…±äº‹æ¥­éå¤šã€‚åœ°æ–¹ã‹ã‚‰éƒ½å¿ƒã¸è³‡é‡‘ãŒæµå‡ºä¸­ã€‚"
    elif final_income < 400:
        comment += "å›½æ°‘è² æ‹…éå¤šã€‚çµŒæ¸ˆæ´»å‹•ãŒåœæ­¢ã™ã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚"
    elif best_match == "å›½æ°‘æ°‘ä¸»å…šæ¡ˆ (é«˜åœ§çµŒæ¸ˆ)":
        comment += "æ‰‹å–ã‚Šé‡è¦–ã®ç©æ¥µè²¡æ”¿ã€‚ä¾›çµ¦åˆ¶ç´„å¯¾ç­–ãŒéµã§ã™ã€‚"
    else:
        comment += "ãƒãƒ©ãƒ³ã‚¹å‹ã§ã™ãŒã€å¤§ããªæˆé•·ã¯è¦‹è¾¼ã‚ã¾ã›ã‚“ã€‚"
    comment += "</div>"
        
    document.getElementById("result-text").innerHTML = res_html + comment
    
    # 5. Twitterãƒœã‚¿ãƒ³æ›´æ–°
    tweet_body = f"ç§ã®æ”¿ç­–ãƒãƒƒãƒãƒ³ã‚°çµæœï¼š\\nã€{best_match}ã€‘\\nğŸ’°æ‰‹å–ã‚Šï¼š{int(final_income)}ä¸‡å†† ({diff_sign}{diff})\\nğŸ“ˆã‚¤ãƒ³ãƒ•ãƒ¬ï¼š{round(final_inflation, 1)}%\\n\\nç‰©ç†æ³•å‰‡ã«åŸºã¥ãã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ #æ”¿å…šãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼"
    url = f"https://twitter.com/intent/tweet?text={window.encodeURIComponent(tweet_body)}"
    
    btn = document.getElementById("twitter-share")
    btn.setAttribute("href", url)
    btn.classList.remove("disabled", "btn-dark")
    btn.classList.add("btn-primary")

# åˆæœŸåŒ–å‡¦ç†ï¼šPythonã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
def main():
    btn = document.getElementById("run_btn")
    btn.innerText = "æœªæ¥ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ ğŸš€"
    btn.classList.remove("btn-secondary")
    btn.classList.add("btn-primary")
    btn.disabled = False
    
    run_proxy = create_proxy(run_simulation)
    btn.addEventListener("click", run_proxy)

main()
</py-script>

</body>
</html>