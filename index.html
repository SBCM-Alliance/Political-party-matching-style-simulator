<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿å…šãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    
    <!-- PyScript & Bootstrap -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <py-config>
        packages = ["matplotlib", "pandas", "numpy"]
    </py-config>

    <style>
        body { background-color: #f8f9fa; font-family: "Helvetica Neue", Arial, sans-serif; }
        .header-area { background: #2c3e50; color: white; padding: 20px 0; margin-bottom: 30px; }
        .simulator-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .result-box { background: #e9ecef; color: #2c3e50; padding: 20px; border-radius: 8px; margin-top: 15px; border-left: 5px solid #3498db; }
        .param-label { font-weight: bold; color: #555; }
        #plot-area { width: 100%; height: 400px; }
        .btn-about { border: 1px solid white; color: white; }
        .btn-about:hover { background: white; color: #2c3e50; }
    </style>
</head>
<body>

<!-- Header -->
<div class="header-area">
    <div class="container d-flex justify-content-between align-items-center">
        <h2 class="m-0">ğŸ—³ï¸ æ”¿å…šãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
        <button class="btn btn-sm btn-about" data-bs-toggle="modal" data-bs-target="#aboutModal">
            â“˜ ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦
        </button>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Input Panel -->
        <div class="col-lg-4">
            <div class="simulator-card">
                <h5 class="mb-4">ğŸ›ï¸ ã‚ãªãŸãŒæœ›ã‚€æ”¿ç­–ã¯ï¼Ÿ</h5>
                
                <div class="mb-4">
                    <label class="param-label">æ¶ˆè²»ç¨ç‡</label>
                    <input type="range" class="form-range" id="tax_rate" min="0" max="25" value="10" oninput="update_val('val_tax', this.value)">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">æ¸›ç¨</small>
                        <span id="val_tax" class="fw-bold">10%</span>
                        <small class="text-muted">å¢—ç¨</small>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="param-label">å…¬å…±äº‹æ¥­è²» (å¹´é¡)</label>
                    <input type="range" class="form-range" id="public_inv" min="2" max="20" value="6" oninput="update_val('val_inv', this.value)">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">æŠ‘åˆ¶</small>
                        <span id="val_inv" class="fw-bold">6å…†å††</span>
                        <small class="text-muted">ç©æ¥µ</small>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="param-label">ç¤¾ä¼šä¿é™ºæ–™è² æ‹… (åŠ´ä½¿è¨ˆ)</label>
                    <input type="range" class="form-range" id="social_sec" min="20" max="40" value="30" oninput="update_val('val_sec', this.value)">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">è»½æ¸›</small>
                        <span id="val_sec" class="fw-bold">30%</span>
                        <small class="text-muted">ç¶­æŒãƒ»å¢—</small>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="param-label">é‡‘åˆ©æ”¿ç­–</label>
                    <input type="range" class="form-range" id="interest" min="-0.1" max="5.0" step="0.1" value="0.25" oninput="update_val('val_int', this.value)">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">ç·©å’Œ</small>
                        <span id="val_int" class="fw-bold">0.25%</span>
                        <small class="text-muted">å¼•ãç· ã‚</small>
                    </div>
                </div>

                <button id="run-btn" class="btn btn-primary w-100 py-2 fw-bold" py-click="run_simulation">
                    æœªæ¥ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- Result Panel -->
        <div class="col-lg-8">
            <div class="simulator-card">
                <h5 class="mb-3">ğŸ“Š 5å¹´å¾Œã®æ—¥æœ¬çµŒæ¸ˆäºˆæ¸¬</h5>
                <div id="plot-area"></div>
                
                <div id="result-text" class="result-box">
                    <strong>ğŸ‘ˆ å·¦ã®ãƒ‘ãƒãƒ«ã§æ”¿ç­–ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</strong><br>
                    ã‚ãªãŸã®é¸æŠãŒã€éå»ã®ã©ã®æ”¿æ¨©ã«è¿‘ã„ã‹ã€ãã—ã¦5å¹´å¾Œã®ç§ãŸã¡ã®ç”Ÿæ´»ï¼ˆæ‰‹å–ã‚Šãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬ç‡ï¼‰ãŒã©ã†ãªã‚‹ã‹ã‚’å³åº§ã«è¨ˆç®—ã—ã¾ã™ã€‚
                </div>

                <div class="mt-4 text-center">
                    <a id="twitter-share" href="#" target="_blank" class="btn btn-dark disabled rounded-pill px-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-twitter-x" viewBox="0 0 16 16">
                            <path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z"/>
                        </svg> çµæœã‚’ãƒã‚¹ãƒˆã™ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã¤ã„ã¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€å˜ãªã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒãƒãƒ³ã‚°ã§ã¯ãªãã€çµŒæ¸ˆç‰©ç†å­¦ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦æ”¿ç­–ã®å½±éŸ¿ã‚’å®šé‡çš„ã«è¨ˆç®—ã™ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚</p>
                <hr>
                <h6>ğŸ§ª åŸºç¤ç†è«–</h6>
                <p><strong>Standard Block Comparison Method (SBCM)</strong></p>
                <p class="small text-muted">
                    å¾“æ¥ã®çµŒæ¸ˆå­¦ã§ã¯ãªãã€ç†±åŠ›å­¦ã‚„æµä½“åŠ›å­¦ã®æ³•å‰‡ã‚’çµ±æ²»æ©Ÿæ§‹ã«å¿œç”¨ã—ãŸã€Œçµ±æ²»å·¥å­¦ï¼ˆGovernance Engineeringï¼‰ã€ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚<br>
                    ç‰¹ã«ã€Œç—›ã¿ã®ä¿å­˜å‰‡ã€ã‚„ã€Œæ¼å‡ºã®å®šç†ã€ã¨ã„ã£ãŸç‰©ç†æ³•å‰‡ã‚’ç”¨ã„ã¦ã€è²¡æ”¿å‡ºå‹•ã®åŠ¹æœã‚„å‰¯ä½œç”¨ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
                </p>
                <hr>
                <h6>ğŸ”— é–‹ç™ºãƒ»ãƒªã‚½ãƒ¼ã‚¹</h6>
                <p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ç†è«–è©³ç´°ã¯GitHubã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <a href="https://github.com/SBCM-Alliance" target="_blank" class="btn btn-outline-dark btn-sm w-100">
                    GitHub: SBCM-Alliance
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    function update_val(id, val) {
        let suffix = '%';
        if(id === 'val_inv') suffix = 'å…†å††';
        document.getElementById(id).innerText = val + suffix;
    }
</script>

<py-script>
import matplotlib.pyplot as plt
import matplotlib as mpl
import numpy as np
from js import document

# æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆPyScriptç’°å¢ƒã§ã®æ–‡å­—åŒ–ã‘å¯¾ç­–ã®ãŸã‚è‹±èªè¡¨è¨˜ã«é€ƒã’ã‚‹ã‹ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€šã™ï¼‰
# ä»Šå›ã¯å®‰å…¨ã®ãŸã‚è‹±èªãƒ©ãƒ™ãƒ«ã‚’ä½¿ç”¨ã—ã€UIå´ã§æ—¥æœ¬èªè£œè¶³ã‚’è¡Œã†è¨­è¨ˆ

def run_simulation(*args):
    # 1. å…¥åŠ›å–å¾—
    tax_rate = float(Element("tax_rate").value)
    public_inv = float(Element("public_inv").value)
    social_sec = float(Element("social_sec").value)
    interest = float(Element("interest").value)

    # 2. ç‰©ç†è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ (SBCM Logic Hidden Layer)
    base_income = 450 # å¹³å‡æ‰‹å–ã‚Š(ä¸‡å††)
    
    # è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç—›ã¿ã®ä¿å­˜å‰‡ï¼‰
    income_delta = - (tax_rate - 10) * 0.8 - (social_sec - 30) * 0.9
    
    # è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ¼å‡ºã®å®šç†ï¼‰
    # å…¬å…±äº‹æ¥­ãŒé©æ­£é‡ã‚’è¶…ãˆã‚‹ã¨ã€GDPåŠ¹æœãŒæ¸›å°‘ã—ã€æ­ªã¿ï¼ˆDistortionï¼‰ãŒå¢—å¤§ã™ã‚‹
    threshold = 6.0
    if public_inv <= threshold:
        inv_efficiency = 1.0
        distortion_score = 1.0
    else:
        inv_efficiency = 1.0 / ((public_inv - threshold) * 0.5 + 1)
        distortion_score = 1.0 + (public_inv - threshold) * 0.3 # æ­ªã¿æŒ‡æ•°

    gdp_boost = (public_inv - 6) * inv_efficiency * 0.5
    
    # è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚¤ãƒ³ãƒ”ãƒ¼ãƒ€ãƒ³ã‚¹ä¸æ•´åˆï¼‰
    inf_suppression = interest * 0.6
    mortgage_impact = interest * 1.5 # ä½å®…ãƒ­ãƒ¼ãƒ³ç­‰ã¸ã®æ‰“æ’ƒ
    
    # çµæœç®—å‡º
    final_income = base_income * (1 + income_delta / 100) - (mortgage_impact * 5)
    final_inflation = 2.0 + gdp_boost * 0.3 - inf_suppression
    
    # æ­´å²çš„ãƒãƒƒãƒãƒ³ã‚°
    history = {
        "æ©‹æœ¬è¡Œé© (1997)": [5, 8, 20, 0.5],
        "å°æ³‰æ”¹é© (2005)": [5, 5, 22, 0.1],
        "æ°‘ä¸»å…šæ”¿æ¨© (2009)": [5, 4, 24, 0.1],
        "ã‚¢ãƒ™ãƒãƒŸã‚¯ã‚¹ (2013)": [8, 10, 26, 0.0],
        "å²¸ç”°æ”¿æ¨© (2024)": [10, 6, 30, 0.25]
    }
    
    current = np.array([tax_rate, public_inv, social_sec, interest])
    best_match = "è©²å½“ãªã—ï¼ˆæœªçŸ¥ã®é ˜åŸŸï¼‰"
    min_dist = 9999
    
    for name, params in history.items():
        dist = np.linalg.norm(current - np.array(params))
        if dist < min_dist:
            min_dist = dist
            best_match = name
            
    # ç‰¹æ®Šåˆ¤å®šï¼ˆSBCMãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    special_tag = ""
    if tax_rate <= 5 and social_sec <= 28:
        best_match = "å›½æ°‘æ°‘ä¸»å…šæ¡ˆ (é«˜åœ§çµŒæ¸ˆ)"
        special_tag = "ã€åˆ¤å®šï¼šæ‰‹å–ã‚Šæœ€å¤§åŒ–ã€‘"
    if tax_rate >= 15 and public_inv >= 10:
        best_match = "è²¡æ”¿ç ´ç¶»ã‚·ãƒŠãƒªã‚ª"
        special_tag = "ã€åˆ¤å®šï¼šç†±çš„æ­» (Heat Death)ã€‘"

    # 3. ã‚°ãƒ©ãƒ•æç”»
    plt.clf()
    fig, ax = plt.subplots(figsize=(8, 4))
    
    # ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿
    labels = ['Income', 'Inflation', 'Inefficiency'] # è‹±èªè¡¨è¨˜ã§å®‰å…¨æ€§ç¢ºä¿
    # Income: æ‰‹å–ã‚Š, Inflation: ç‰©ä¾¡, Inefficiency: è¡Œæ”¿ã®æ­ªã¿
    
    val_income = 100 + (final_income - base_income)/base_income * 100
    val_inf = 100 + (final_inflation - 2) * 10
    val_dist = 100 + (distortion_score - 1) * 50
    
    values = [val_income, val_inf, val_dist]
    colors = ['#2ecc71', '#e74c3c', '#95a5a6'] # ç·‘ã€èµ¤ã€ã‚°ãƒ¬ãƒ¼
    
    ax.bar(labels, values, color=colors, alpha=0.7)
    ax.axhline(100, color='black', linestyle='--', linewidth=1)
    ax.set_ylim(50, 160)
    ax.set_title(f"Simulation Result", fontsize=12)
    ax.text(0, val_income + 2, f"{int(final_income)}0k", ha='center', fontweight='bold')
    ax.text(1, val_inf + 2, f"{round(final_inflation, 1)}%", ha='center', fontweight='bold')
    ax.text(2, val_dist + 2, f"x{round(distortion_score, 1)}", ha='center', fontweight='bold')
    
    # Xè»¸ãƒ©ãƒ™ãƒ«ã‚’æ—¥æœ¬èªã«ç½®ãæ›ãˆã‚‹ãƒˆãƒªãƒƒã‚¯ï¼ˆç”»åƒç”Ÿæˆå¾Œï¼‰ã¯PyScriptã ã¨è¤‡é›‘ã«ãªã‚‹ãŸã‚
    # ä¸‹éƒ¨ãƒ†ã‚­ã‚¹ãƒˆã§è£œè¶³ã™ã‚‹è¨­è¨ˆã«ã™ã‚‹
    
    display(fig, target="plot-area", append=False)
    
    # 4. çµæœãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    diff = int(final_income - base_income)
    diff_sign = "+" if diff > 0 else ""
    
    res_html = f"<h5>è¨ºæ–­ï¼šã‚ãªãŸã®æ”¿ç­–ã¯ã€{best_match}ã€ã§ã™</h5>"
    res_html += f"<p class='mb-1'>{special_tag}</p>"
    res_html += f"<ul>"
    res_html += f"<li><strong>å¹³å‡æ‰‹å–ã‚Š:</strong> ç´„{int(final_income)}ä¸‡å†† <span class='text-primary'>({diff_sign}{diff}ä¸‡å††)</span></li>"
    res_html += f"<li><strong>ã‚¤ãƒ³ãƒ•ãƒ¬ç‡:</strong> {round(final_inflation, 1)}%</li>"
    res_html += f"<li><strong>è¡Œæ”¿ã®ãƒ ãƒ€(æ­ªã¿):</strong> åŸºæº–ã® {round(distortion_score, 1)}å€</li>"
    res_html += f"</ul>"
    
    # å®šæ€§åˆ†æ
    comment = "<strong>ğŸ¤– ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ:</strong><br>"
    if distortion_score > 1.3:
        comment += "å…¬å…±äº‹æ¥­ãŒéå‰°ã§ã™ã€‚åœ°æ–¹çµŒæ¸ˆã®ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’è¶…ãˆã€è³‡é‡‘ãŒéƒ½å¿ƒã¸é‚„æµï¼ˆæ¼å‡ºï¼‰ã—ã¦ã„ã¾ã™ã€‚"
    elif final_income < 400:
        comment += "å›½æ°‘è² æ‹…ãŒé«˜ã™ãã¾ã™ã€‚çµŒæ¸ˆæ´»å‹•ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæ¯æ¸‡ã—ã€ã‚·ã‚¹ãƒ†ãƒ ç¶­æŒãŒå›°é›£ã«ãªã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚"
    elif best_match == "å›½æ°‘æ°‘ä¸»å…šæ¡ˆ (é«˜åœ§çµŒæ¸ˆ)":
        comment += "æ‰‹å–ã‚Šé‡è¦–ã®ç©æ¥µè²¡æ”¿ã§ã™ã€‚ä¾›çµ¦åˆ¶ç´„ï¼ˆäººæ‰‹ä¸è¶³ï¼‰ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ¬å¯¾ç­–ãŒæˆåŠŸã®éµã¨ãªã‚Šã¾ã™ã€‚"
    else:
        comment += "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸæ§‹æˆã§ã™ãŒã€ç¾çŠ¶ç¶­æŒãƒã‚¤ã‚¢ã‚¹ãŒå¼·ãã€å¤§ããªæˆé•·ã¯è¦‹è¾¼ã‚ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
        
    Element("result-text").element.innerHTML = res_html + comment
    
    # 5. Twitterãƒœã‚¿ãƒ³æ›´æ–°
    tweet_body = f"ç§ã®æ”¿ç­–ãƒãƒƒãƒãƒ³ã‚°çµæœï¼š\\nã€{best_match}ã€‘\\nğŸ’°æ‰‹å–ã‚Šï¼š{int(final_income)}ä¸‡å†† ({diff_sign}{diff})\\nğŸ“ˆã‚¤ãƒ³ãƒ•ãƒ¬ï¼š{round(final_inflation, 1)}%\\n\\nç‰©ç†æ³•å‰‡ã«åŸºã¥ãã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ #æ”¿å…šãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼"
    url = f"https://twitter.com/intent/tweet?text={encoded_text(tweet_body)}"
    
    btn = Element("twitter-share")
    btn.element.setAttribute("href", url)
    btn.remove_class("disabled")
    btn.remove_class("btn-dark")
    btn.add_class("btn-primary")

def encoded_text(text):
    import urllib.parse
    return urllib.parse.quote(text)

</py-script>

</body>
</html>